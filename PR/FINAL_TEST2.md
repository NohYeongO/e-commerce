## 1. 테스트 목적
서비스 주요 API의 성능 데이터를 분석하고, 동시 요청 처리 시 나타나는 병목 지점을 탐색하여 개선 방향을 도출하기 위한 목적으로 수행되었습니다.  
테스트 결과는 InfluxDB에 저장하고, Grafana 대시보드를 통해 시각화하여 성능 상태를 파악하였습니다.
또한, 테스트 중 발생 가능한 장애 상황에 대한 대응 방안을 수립하였습니다.

## 2. 테스트 환경

### 하드웨어
- **기기**: Apple MacBook Pro (M3 Pro)
- **프로세서**: M3 Pro (11코어 CPU, 14코어 GPU)
- **메모리 (RAM)**: 18GB
- **저장 공간 (SSD)**: 512GB
- **네트워크 환경**: 로컬 환경 (localhost)

### 소프트웨어
- **운영체제**: macOS Ventura (또는 최신 macOS 버전)
- **테스트 도구**: k6 (버전 0.43 이상)
- **스크립트 작성 언어**: JavaScript
- **데이터 저장 및 시각화**:
    - **InfluxDB**: 테스트 데이터를 저장하는 시계열 데이터베이스
    - **Grafana**: InfluxDB 데이터를 시각화하여 대시보드 제공
  
## 3. 주요 성능 지표
<img height="" src="시나리오 테스트 시각화.png" width="1200"/>

## 4. 병목 탐색 및 분석
### 상품 주문:

**최대 응답 시간** - 953ms.

- **문제 원인**: 동시 요청 처리 중 **비관적 락(Pessimistic Lock)**이 사용됨에 따라, 트랜잭션 경합으로 대기 상태가 발생하여 응답 시간이 지연됨.   
- **분석**: 여러 사용자가 동시에 주문을 생성하려는 상황에서 데이터베이스 잠금이 오래 유지되며 병목이 발생한 것으로 추정.

### 2차 잔액 충전:
**최대 응답 시간** - 922ms
- **문제 원인**: 동일 사용자가 잔액 충전과 주문 요청을 거의 동시에 실행하면서 **분산 락(Distributed Lock)**이 충전 작업과 주문 작업에 적용되어 응답 시간이 길어짐.
- **분석**: 분산 락이 양쪽 작업에 동시에 적용되며, 충전 트랜잭션 완료를 대기하는 동안 주문 요청의 지연이 발생한 것으로 판단됨.

### * 성공 사례 API *
### " 상위 5개 상품 조회 "  
**평균 응답 시간**: 12ms   
**최대 응답 시간**: 346ms   
- 데이터가 백만건을 조회하지만 캐싱 적용으로 인해 데이터베이스 호출 없이 빠르게 처리.    
- 조회 데이터가 자주 변경되지 않으므로 스케줄링을 사용해 매일 00시에 캐싱.

## 5. 장애 대응 계획

- **캐싱 활용**
    - 주문 처리에 필요한 정적 데이터를 캐싱하여 데이터베이스 접근을 줄임.
    - 예: 상품 정보 및 가격이 조회 될때 데이터 캐싱을 통해 상품 조회 시간 단축
    - 추가적으로 인덱스를 활용한 빠른 탐색지원.
- **트랜잭션 타임아웃 설정**
    - 비관적 락의 대기 시간을 제한하여 지연 요청을 빠르게 처리하거나 실패로 반환.
- **실시간 모니터링**
    - Grafana를 통해 트랜잭션 대기 시간 및 요청 처리량을 지속적으로 관찰.
    - 응답 시간이 비정상적으로 증가하는 경우 경고 알림 발송.

## 6. 마무리

이번 테스트를 통해 **서비스 주요 API의 성능 및 병목 지점**을 확인할 수 있었습니다.
- **문제**: 상품 주문에서의 트랜잭션 대기 및 2차 잔액 충전 요청의 분산 락 충돌로 인해 일부 요청이 지연.
- **성공 사례**: 상위 5개 상품 조회 API는 캐싱과 인덱스를 통해 대규모 데이터에서도 빠른 응답을 유지.

#### **추가 조치**
- **캐싱**: 데이터 캐싱을 적극적으로 활용하여 데이터베이스 접근을 최소화할 예정입니다.
- **인덱스 최적화**: 자주 조회되는 데이터를 위한 인덱스를 추가하여 검색 속도를 향상시킬 계획입니다.
- **트랜잭션 타임아웃**: 비관적 락 대기 시간을 제한하여 지연 요청을 효율적으로 관리하겠습니다.
- **모니터링 강화**: Grafana를 활용하여 실시간 성능 상태를 지속적으로 점검할 예정입니다.
