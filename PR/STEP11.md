### **`STEP 11_기본`**

- 나의 시나리오에서 발생할 수 있는 동시성 이슈에 대해 파악하고 가능한 동시성 제어 방식들을 도입해보고 각각의 장단점을 파악한 내용을 정리 제출
    - 구현의 복잡도, 성능, 효율성 등
    - README 작성 혹은 외부 링크, 프로젝트 내의 다른 문서에 작성하였다면 README 에 링크 게재

---

## 나의 시나리오에서 발생할 동시성 이슈
1. **충전 및 잔고 차감에 대한 동시성 이슈**
    - 사용자가 잔액 충전을 동시에 요청할 때, 충전과 잔고 차감 작업이 동시에 진행되면 충돌이 발생할 수 있습니다.
2. **재고 차감에 대한 동시성 이슈**
    - 여러 사용자가 동시에 동일한 상품을 구매할 때, 재고 차감 작업에서 충돌이 발생할 수 있습니다.
    - 예를 들어, 재고가 10개인 상품에 대해 11명의 사용자가 동시에 구매 요청을 할 경우, 재고가 초과 차감되거나 일부 사용자에게 판매가 불가능해지는 문제가 발생할 수 있습니다.

## 내가 사용할 락

1. **분산 락**
    - **충전 및 잔고 차감에 대한 동시성 처리**: 충전과 잔고 차감 작업에는 분산 락을 사용할 예정입니다. 처음에는 충돌이 많이 발생하지 않을 것 같아 낙관적 락을 고려했지만, 금액과 관련된 작업인 만큼 확실한 처리를 위해 비관적 락이 더 적합하다는 생각을 했었지만
      한 회원에 대해 락을 걸어야 하므로 `userId`를 키 값으로 사용하고 Redis를 활용함으로써 같은 회원에 대한 충돌 오류를 방지할 수 있을 것이라고 생각합니다.

2. **비관적 락**
    - **재고 차감에 대한 동시성 처리**: 재고 차감 작업에서는 비관적 락을 사용할 계획입니다. 여러 사용자가 동시에 구매를 시도할 가능성이 있기 때문에, 데이터의 일관성을 유지하기 위해 비관적 락을 적용하는게 적합하다고 생각합니다.



# 동시성이란?

동시성이란 여러 프로세스가 동시에 자원에 접근하려고 할 때 발생하는 상황을 의미합니다. 예를 들어, 두 개의 프로세스가 동일한 데이터베이스 레코드에 동시에 접근하여 변경을 시도하는 경우, 첫 번째 프로세스가 데이터를 조회한 후 변경을 시도하는 과정에서 두 번째 프로세스가 그 데이터를 먼저 조회하게 됩니다.

이런 상황에서 첫 번째 프로세스가 변경사항을 커밋한 후, 두 번째 프로세스도 커밋을 시도하면, 두 프로세스의 변경사항이 서로 충돌하게 되면서 데이터의 일관성이 깨지는 오류가 발생할 수 있습니다.

## 동시성 문제 해결 방법

동시성 문제를 해결하기 위해 가장 일반적으로 사용되는 방법이 **락(Lock)**입니다. 락을 통해 데이터에 대한 접근을 제어하면, 특정 프로세스가 데이터를 변경하기 전에 락을 획득하고, 커밋 이후에 락을 해제하여 데이터베이스의 일관성을 유지할 수 있습니다.

락을 통해 여러 프로세스가 동시에 자원에 접근하더라도 데이터의 무결성과 일관성을 보장할 수 있습니다.

## 락의 종류

### 1. 비관적 락
- **개념**: 트랜잭션이 데이터를 조회하는 즉시 락을 걸어, 다른 트랜잭션이 해당 데이터에 접근하지 못하게 대기시키는 방식입니다.
- **작동 방식**: 락을 건 트랜잭션이 종료될 때까지 다른 트랜잭션의 접근을 차단하여 동시성을 제어하고, 데이터 일관성을 유지합니다. 락이 해제되면 이후 트랜잭션은 변경된 데이터를 확인할 수 있습니다.
- **단점**:
    - 트랜잭션이 락을 해제하지 못하고 대기 상태가 길어지면 **데드락(Deadlock)**이 발생할 수 있습니다.
    - 요청이 많은 환경에서는 모든 트랜잭션이 락 대기 상태에 놓일 수 있어, 시스템 성능이 저하될 위험이 있습니다.

### 2. 낙관적 락
- **개념**: 데이터 변경이 자주 발생하지 않으며, 트랜잭션 간 충돌 가능성이 낮다고 가정하고 사용합니다.
- **작동 방식**: 조회 시에는 락을 걸지 않고 수정 시에만 **버전 정보(version)**를 활용해 데이터의 변경 여부를 확인합니다. 트랜잭션이 커밋되는 시점에 버전 정보가 바뀌었다면, 다른 트랜잭션이 데이터를 수정했음을 감지하고 롤백합니다.
- **단점**:
    - 충돌이 많아질 경우 성능이 저하될 수 있습니다.
    - 데이터 수정이 잦은 경우에는 부적합할 수 있습니다.

### 3. 분산 락
- **개념**: 여러 서버 간에 공유 자원에 대한 동시 접근을 제어하기 위해 사용되는 락입니다. 주로 Redis, ZooKeeper 등을 활용하여 구현됩니다.
- **작동 방식**: 분산 환경에서 자원에 대한 접근을 조정하며, 클러스터 내의 모든 노드가 락 상태를 인식하고 관리할 수 있도록 합니다.
- **단점**:
    - 구현이 복잡하며, 네트워크 지연으로 인해 성능에 영향을 줄 수 있습니다.

---

그냥 이해한 정보를 토대로 간단하게 정리 했습니다. 아직 분산락에 대해서 조금더 공부해야할 거 같고 사용방법에 대해서도 학습이 필요할 것 같습니다.
발제시간에 사진이 이론적으로 이해하는데 도움이 많이 됐습니다!!!